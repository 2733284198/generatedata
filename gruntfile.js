const fs = require('fs');

module.exports = function (grunt) {	
	const dataTypesFolder = 'src/plugins/dataTypes';
	const locales = ['en'];

	const generateI18nBundles = () => {
		locales.forEach((locale) => {
			const dtImports = getDataTypeLocaleFilePaths(locale);

			generateLocaleFileTemplate(locale, dtImports);
		});
	};

	const getDataTypeLocaleFilePaths = (locale) 	=> {
		const dataTypeFolders = fs.readdirSync(dataTypesFolder);
		const dtImports = {};
		dataTypeFolders.forEach((folder) => {
			const localeFile = `${dataTypesFolder}/${folder}/i18n/${locale}.json`;
			if (fs.existsSync(`${localeFile}.ts`)) {
				dtImports[folder] = `import ${folder} from '../${localeFile}';`;
			}
		});
		return dtImports;
	};

	const generateLocaleFileTemplate = (locale, dtImports) => {
		const template = `
// DO NOT EDIT. This file is generated by a Grunt task.
import coreLocaleStrings from '../src/i18n/${locale}';

// import all English files here
${Object.values(dtImports).join('\n')}

(function() { 
	// now construct a single object containing the whole shebang
	const i18n = {
		...coreLocaleStrings,
		dataTypes: {
			${Object.keys(dtImports).join(',\n\t\t\t')}
		},
		exportTypes: {

		}
	};

	// load the locale info via an exposed global
	window.gd.localeLoaded(i18n);
})();`;

		fs.writeFileSync(`./build/${locale}-bundle.ts`, template);
	};

	grunt.initConfig({
		cssmin: {
			options: {
				mergeIntoShorthands: false,
				roundingPrecision: -1
			},
			target: {
				files: {
					'dist/styles.css': [
						'src/resources/codemirror.css',
						'src/resources/ambience.css',
						'src/resources/cobalt.css',
						'src/resources/darcula.css',
						'src/resources/elegant.css',
						'src/resources/lucario.css'
					]
				}
			}
		}
	});

	grunt.loadNpmTasks('grunt-contrib-cssmin');
	grunt.registerTask('default', ['cssmin']);
	grunt.registerTask('i18n', generateI18nBundles);
};