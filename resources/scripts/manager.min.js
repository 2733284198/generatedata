define(["constants","queue"],function(f,j){var k=!1,e={},l=""===f.DEBUGGING.LIMIT_DATA_TYPE_EVENTS?!1:!0,m=""===f.DEBUGGING.LIMIT_EXPORT_TYPE_EVENTS?!1:!0,n=f.DEBUGGING.LIMIT_DATA_TYPE_EVENTS.split(","),p=f.DEBUGGING.LIMIT_EXPORT_TYPE_EVENTS.split(","),h=function(a){$.isArray(a)||(a=[a]);for(var c=0;c<a.length;c++){var b=q(a[c].sender);if(f.DEBUGGING.LIST_PUBLISH_EVENTS){var d=!1;"data-type"==b?l?-1!=$.inArray(a[c].sender,n)&&(d=!0):d=!0:"export-type"==b?m?-1!=$.inArray(a[c].sender,p)&&(d=!0):d=!0: d=!0;d&&console.log("manager.publish(): ",a[c])}var b=a[c].type,g;for(g in e)if(e[g].subscriptions.hasOwnProperty(b))e[g].subscriptions[b](a[c])}},q=function(a){var c=/^export-type-/,b=/^core-/,d=null;/^data-type-/.test(a)?d="data-type":c.test(a)?d="export-type":b.test(a)&&(d="core");return d},r=function(){};return{registerDataType:function(a,c){if(e.hasOwnProperty(a))f.DEBUGGING.CONSOLE_WARN&&console.warn("Sorry, a module with that ID has already been registered.");else{for(var b=["init","run","validate", "saveRow","loadRow"],d=0;d<b.length;d++)if(c.hasOwnProperty(b[d])&&"function"!=typeof c[b[d]]){f.DEBUGGING.CONSOLE_WARN&&console.warn(a+" module has an invalid "+b[d]+"() function. Should be a function!");return}b=$.extend({init:function(){},run:function(){},validate:function(){return[]},saveRow:function(){return{}},loadRow:null,skipDomReady:!1,subscriptions:{}},c);b.type=f.COMPONENT.DATA_TYPE;e[a]=b;h({sender:a,type:f.EVENT.MODULE.REGISTER})}},registerExportType:function(a,c){if(e.hasOwnProperty(a))f.DEBUGGING.CONSOLE_WARN&& console.warn("Sorry, a module with that ID has already been registered.");else{for(var b="init run validate saveSettings loadSettings resetSettings".split(" "),d=0;d<b.length;d++)if(c.hasOwnProperty(b[d])&&"function"!=typeof c[b[d]]){f.DEBUGGING.CONSOLE_WARN&&console.warn(a+" module has an invalid "+b[d]+"() function. Should be a function!");return}b=$.extend({init:function(){},run:function(){},validate:function(){return[]},saveSettings:function(){return{}},loadSettings:null,resetSettings:function(){}, subscriptions:{}},c);b.type=f.COMPONENT.EXPORT_TYPE;e[a]=b;h({sender:a,type:f.EVENT.MODULE.REGISTER})}},registerCoreModule:function(a,c){if(e.hasOwnProperty(a))f.DEBUGGING.CONSOLE_WARN&&console.warn("Sorry, a module with that ID has already been registered.");else{var b=$.extend({init:function(){},run:function(){},skipDomReady:!1,subscriptions:{}},c);b.type=f.COMPONENT.CORE;e[a]=b;h({sender:a,type:f.EVENT.MODULE.REGISTER})}},publish:h,subscribe:function(a,c){if(2!=arguments.length)f.DEBUGGING.CONSOLE_WARN&& console.warn("Invalid params for manager.subscribe()");else{var b={},d;for(d in c){var g=c[d];"function"==typeof g&&(b[d]=g)}if(e.hasOwnProperty(a)){var h=e[a].subscriptions,g=q(a);for(d in b)h[d]=b[d];e[a].subscriptions=h;f.DEBUGGING.LIST_SUBSCRIBE_EVENTS&&(d=!1,"data-type"==g?l?-1!=$.inArray(a,n)&&(d=!0):d=!0:"export-type"==g?m?-1!=$.inArray(a,p)&&(d=!0):d=!0:d=!0,d&&console.log("manager.subscribe(): ",a,b))}}},unsubscribe:function(){},getModules:function(){return e},loadDataTypeRows:function(a){for(var c= 0;c<a.length;c++){var b=a[c].dataType;e.hasOwnProperty(b)&&(b=e[b].loadRow(a[c].rowID,a[c].data),null!==b&&j.add(b))}j.process({onSuccess:r})},validateDataTypes:function(a){var c=[],b;for(b in e)if(e[b].type==f.COMPONENT.DATA_TYPE&&a.hasOwnProperty(b)){var d=e[b].validate(a[b]);$.isArray(d)&&d.length&&(c=c.concat(d))}return c},validateExportType:function(a){var c="export-type-"+a.exportType,b=a.rows,d=[];try{d=e[c].validate(b)}catch(g){return f.DEBUGGING.CONSOLE_WARN&&console.error("Error in validate() function for "+ a.exportType+" Export Type. Error: ",g),null}return!$.isArray(d)?(f.DEBUGGING.CONSOLE_WARN&&console.error("Error! The validate() function for "+a.exportType+" didn't return an array."),null):d},serializeDataTypeRow:function(a,c){if(e.hasOwnProperty(a))return e[a].saveRow(c);f.DEBUGGING.CONSOLE_WARN&&console.warn("Unknown data type for manager.serializeDataTypeRow(): "+a)},serializeExportTypes:function(){var a=/^export-type-/,c={},b;for(b in e)if(a.test(b))try{c[b]=e[b].saveSettings()}catch(d){f.DEBUGGING.CONSOLE_WARN&& console.warn("Error in Export Type's saveSettings(): ",b,d)}return c},loadExportType:function(a,c){var b="export-type-"+a;if(e.hasOwnProperty(b)&&c.hasOwnProperty(b))try{e[b].loadSettings(c[b])}catch(d){f.DEBUGGING.CONSOLE_WARN&&console.warn("Error in Export Type's loadSettings(): ",b,d)}},resetExportTypes:function(){var a=[],c;for(c in e)"export-type"==e[c].type&&a.push(e[c]);for(c=0;c<a.length;c++)try{a[c].resetSettings()}catch(b){f.DEBUGGING.CONSOLE_WARN&&console.warn("Error resetting export type: ", a[c],b)}},start:function(){if(!k){for(var a in e)if(e.hasOwnProperty(a)){var c=a;if(null!==e[c].init)try{e[c].init()}catch(b){f.DEBUGGING.CONSOLE_WARN&&(console.warn("init() method failed for "+c+":",b),e.hasOwnProperty(c)&&(delete e[c],f.DEBUGGING.CONSOLE_LOG_CORE&&console.warn("module unregistered: "+c)))}}for(var d in e)try{e[d].run()}catch(g){console.warn(g)}k=!0}}}});